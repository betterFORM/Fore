
<style>
    fore-bridge{
        position:absolute;
        right:3px;
        top:3px;
        padding:5px;
        border:1px solid;
    }
    #log {
        background: none repeat scroll 0 0 lightblue;
        padding: 3px;
        position: absolute;
        right: 0;
        top: 0;
        width: 300px;
        height:auto;
        z-index:1000;
        max-height:600px;

    }
    .value,.readonly,.required,.relevant,.valid{
        padding-left:20px;
        font-weight:bold;
    }
</style>
<script>
    var XFoo = document.registerElement('fore-bridge', {
        prototype: Object.create(HTMLElement.prototype, {
            createdCallback: {
                value: function () {
                    console.log("#created fore-bridge: ", this);

                    //for logging events
                    this.innerHTML="<div id='log'></div>";

                    this.socket = $.atmosphere;
                    console.log("fore-bridge ready", this.socket.uuid);
                    console.log("fore-bridge xfSession", this.getAttribute("xfSession"));
                    that = this;
                    var log = document.querySelector("#log");


                    this.request = {
                        url: '/betterform/msg/' + this.getAttribute("xfSession"),
                        contentType: "application/json; charset=UTF-8",
                        logLevel: 'debug',
                        transport: 'websocket',
                        trackMessageLength: true,
                        fallbackTransport: 'long-polling',


                        onOpen: function (response) {
                            $('<div/>', {
                                text: response.request.uuid
                            }).appendTo(log);
                        },

                        onMessage: function (response) {
                            var message = response.responseBody;

                            console.log("response: ", JSON.stringify(message));
                            var json = null;
                            try {
                                json = jQuery.parseJSON(message);
                            } catch (e) {
                                console.log('This doesn\'t look like a valid JSON: ', message);
                                return;
                            }

                            //loggging messages
                            $('<div/>', {
                                text: json.type
                            }).appendTo(log);

                            if("init-model" == json.type){

                            }
                            if ("betterform-state-changed" == json.type) {
                                var targetId = json.contextInfo.targetId;
                                console.log("executing betterform-state-changed targetId:", targetId);
                                var targetControl =  document.querySelector("#"+json.contextInfo.targetId);

                                if(json.contextInfo.value){
                                    targetControl.setValue(json.contextInfo.value);
                                    $('<div/>', {
                                        text: "value:" + json.contextInfo.value
                                    }).addClass("value").appendTo(log);
                                }

                                if(json.contextInfo.readonly){
                                    targetControl.setReadonly(json.contextInfo.readonly);
                                    $('<div/>', {
                                        text: "readonly:" + json.contextInfo.readonly
                                    }).addClass("readonly").appendTo(log);
                                }

                                if(json.contextInfo.required){
                                    targetControl.setRequired(json.contextInfo.required);
                                    $('<div/>', {
                                        text: "required:" + json.contextInfo.required
                                    }).addClass("required").appendTo(log);
                                }

                                if(json.contextInfo.relevant){
                                    targetControl.setRelevant(json.contextInfo.relevant);
                                    $('<div/>', {
                                        text: "relevant:" + json.contextInfo.relevant
                                    }).addClass("relevant").appendTo(log);

                                }

                            }

                            if ("betterform-render-message" == json.type) {
                                if(json.contextinfo.value !== ""){
                                    targetControl.setValue(json.contextinfo.value);
                                }
                            }

                            if ("xforms-ready" == json.type){
                                console.log("XForms is ready");
                                $("[is='fore-input']").trigger("xforms-ready");
                            }

                            if ("init" === json.eventType) {
                                console.log("jsid:", json.id);
                                var targetControl = document.querySelector('#'+json.id);
                                targetControl.setValue(json.value);
                                targetControl.setReadonly(json.readonly);
                                targetControl.setRequired(json.required);
                                targetControl.setRelevant(json.relevant);
                                targetControl.setValid(json.valid);
                            }

                            if ("valueChange" === json.eventType) {
                                console.log("jsid:", json.id);
                                var targetControl = document.querySelector('#'+json.id);
                                targetControl.setValue(json.value);

                                $('<div/>', {
                                    text: "value:" + json.value
                                }).addClass("value").appendTo(log);

                            }

                        },
                        onClose: function (response) {
                            console.log("onClose called");
                        },

                        onReady:function() {
                            console.log('domReady ' + this.socket.uuid);
                        }


                    };
                    this.subSocket = this.socket.subscribe(this.request);
/*
                    var msg = {
                        eventType:'init-model'
                    };
                    this.subSocket.push(jQuery.stringifyJSON(msg));
*/


                }
            },
            sendMessage: {
                value: function (msg) {
                    console.log("sending message with socket.uuid ", this.socket.uuid);
                    msg.uuid = this.socket.uuid;
                    console.log("pushing: ", msg);
                    this.subSocket.push(jQuery.stringifyJSON(msg));
                }
            }


        })
    });
</script>
